<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Private Metadata Scrubber</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
      body {
        font-family: 'Press Start 2P', system-ui, cursive;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start; /* Move up */
        min-height: 100vh;
        padding-top: 100px; /* Position similar to before */
        padding-left: 0;
        background: #000;
        color: #fff;
        margin: 0;
        overflow-x: hidden;
        cursor: progress; 
      }
      /* Dim the background slightly for readability */
      body::before {
        content: "";
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.2); /* Make transparent as requested */
        z-index: -1;
      }
      canvas#matrix {
        position: fixed;
        top: 0; left: 0;
        z-index: -1;
        opacity: 0.15; /* Subtle Matrix */
      }
      h1 {
        margin-bottom: 2rem;
        background: transparent;
        color: #fff;
        padding: 10px;
        font-size: 1.2rem;
        font-weight: normal;
        letter-spacing: 2px;
        box-shadow: none;
        border: none;
        
        /* Typing Update: Use inline-block to preventing full-width stretching */
        display: inline-block;
        white-space: nowrap;
        overflow: hidden;
        border-right: 12px solid #fff; 
        width: 0;
        animation: typing 3s steps(26, end) forwards, blink 0.75s step-end infinite;
        text-shadow: 2px 2px #000;
      }
      @keyframes typing {
        from { width: 0 }
        to { width: 28ch } /* Adjusted to fit exactly */
      }
      @keyframes blink {
        from, to { border-color: transparent }
        50% { border-color: #fff }
      }
      p {
        color: #fff;
        margin-bottom: 3rem;
        text-shadow: 2px 2px 0 #000;
        background: rgba(0,0,0,0.5);
        padding: 5px 10px;
        font-size: 0.8rem;
        line-height: 1.5;
      }
      #drop-zone {
        width: 100%;
        max-width: 500px;
        height: 250px;
        border: 4px solid #c0c0c0; /* Windows 95 Border */
        border-top-color: #fff;
        border-left-color: #fff;
        border-right-color: #808080;
        border-bottom-color: #808080;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #000080; /* BIOS Blue */
        cursor: pointer;
        transition: 0.1s;
        color: #ffffff; /* White Text as requested */
        box-shadow: 4px 4px 0px #000;
        margin-bottom: 20px;
        text-shadow: 2px 2px #000;
      }
      #drop-zone:hover {
        background: #0000aa;
      }
      #results-area {
        width: 100%;
        max-width: 600px;
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        z-index: 10;
      }
      .file-card {
        background: #c0c0c0; /* Silver Windows */
        border: 2px solid #fff;
        border-bottom-color: #000;
        border-right-color: #000;
        border-top-color: #fff;
        border-left-color: #fff;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
        color: #000;
        position: relative;
        box-shadow: 4px 4px 0 #000;
      }
      .file-card.error {
        border-color: #ff0000; /* Subtle indication */
      }
      .file-card.success {
        border-color: #fff;
      }
      .thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        background: #000;
        border: 2px solid #808080;
        border-bottom-color: #fff;
        border-right-color: #fff;
        border-top-color: #000;
        border-left-color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #fff;
      }
      .file-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center; /* Center metadata vertically */
      }
      .file-name {
        font-weight: normal;
        margin-bottom: 10px;
        display: block;
        font-size: 0.8rem;
        text-align: center; /* Center Name */
      }
      .meta-stats {
        font-size: 0.6rem;
        color: #000;
        display: flex;
        gap: 40px; /* More separation */
        justify-content: center; /* Center Stats */
        align-items: center;
      }
      .stat-group {
        display: flex;
        flex-direction: column;
      }
      .stat-label {
        font-size: 0.65rem;
        text-transform: uppercase;
        color: #000;
      }
      .stat-group:last-child .stat-label, 
      .stat-group:last-child span:last-child {
         color: #008080; /* Teal for "Cleaned" label and value */
         font-weight: bold;
      }
      .download-btn {
        background: #c0c0c0;
        color: #000;
        border: 2px solid #fff;
        border-bottom-color: #000;
        border-right-color: #000;
        padding: 6px 14px;
        cursor: pointer;
        text-decoration: none;
        font-weight: bold;
        font-size: 0.7rem;
        transition: 0.0s;
        font-family: 'Press Start 2P', cursive;
      }
      .download-btn:active {
        border: 2px solid #808080;
        border-bottom-color: #fff;
        border-right-color: #fff;
        border-top-color: #000;
        border-left-color: #000;
        transform: translate(2px, 2px);
      }
      .error-msg {
        color: #d00000;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: bold;
      }
      .icon-large {
        font-size: 3rem;
        margin-bottom: 10px;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <canvas id="matrix"></canvas>
    <h1 id="main-title">SYSTEM://METADATA_SCRUBBER</h1>
    <p>Upload Files. Strip Data. Remain Anonymous.</p>

    <div id="drop-zone" onclick="document.getElementById('fileInput').click()">
      <i class="ri-upload-cloud-2-line icon-large"></i>
      <span>INITIATE UPLOAD SEQUENCE</span>
    </div>
    <input
      type="file"
      id="fileInput"
      style="display: none"
      multiple
      onchange="handleFiles(this.files)"
    />

    <div id="results-area"></div>

    <script>
      const WEBHOOK_URL = "http://localhost:5678/webhook/scrub-file"; // Use your PRODUCTION URL

      const resultsArea = document.getElementById("results-area");

      // Handle Title Animation End
      const title = document.getElementById('main-title');
      title.addEventListener('animationend', (e) => {
        if (e.animationName === 'typing') {
             title.classList.add('typing-done');
        }
      });

      // Matrix Rain Effect (Restored & Customised)
      const canvas = document.getElementById('matrix');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
      const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const nums = '0123456789';
      const alphabet = katakana + latin + nums;
      
      const fontSize = 16;
      const columns = canvas.width/fontSize;
      
      const rainDrops = [];
      for( let x = 0; x < columns; x++ ) {
          rainDrops[x] = 1;
      }
      
      const draw = () => {
          ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          ctx.fillStyle = '#FFFFFF'; /* White Text */
          // Use same font as foreground
          ctx.font = fontSize + 'px "Press Start 2P"'; 
      
          for(let i = 0; i < rainDrops.length; i++)
          {
              const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
              ctx.fillText(text, i*fontSize, rainDrops[i]*fontSize);
              
              if(rainDrops[i]*fontSize > canvas.height && Math.random() > 0.975){
                  rainDrops[i] = 0;
              }
              rainDrops[i]++;
          }
      };
      setInterval(draw, 50); // Slightly slower for 8-bit feel
      window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });

      async function handleFiles(files) {
        // Clear previous results if you want, or keep appending. 
        // resultsArea.innerHTML = ""; 

        // define the ALLOWED extensions (whitelist)
        const allowedExtensions = [
            "jpg", "jpeg", "png", "tiff", "tif", 
            "pdf", "docx", "xlsx", "pptx", 
            "mp4", "mov", "m4v", "qt", 
            "heic", "arw", "cr2", "nef", "dng"
        ];

        for (let file of files) {
          // 1. Create Card UI
          const card = createFileCard(file);
          resultsArea.appendChild(card);
          
          const ui = {
            card: card,
            status: card.querySelector('.file-status'),
            downloadArea: card.querySelector('.download-area'),
            afterSize: card.querySelector('.size-after')
          };

          // 2. Validate Extension
          const ext = file.name.split('.').pop().toLowerCase();
          if (!allowedExtensions.includes(ext)) {
              markError(ui, `File type .${ext} not supported`);
              continue; 
          }

          // 3. Process
          try {
            ui.status.innerText = "Processing...";
            ui.status.style.color = "#000"; /* Black processing text */
            
            let formData = new FormData();
            formData.append("data", file); 

            const response = await fetch(WEBHOOK_URL, {
              method: "POST",
              body: formData,
            });

            if (!response.ok) throw new Error("Backend error");

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            
            // 4. Update UI with Success
            markSuccess(ui, blob, url, file.name);

          } catch (err) {
            markError(ui, "Processing failed. Is server running?");
          }
        }
      }

      function createFileCard(file) {
        const div = document.createElement("div");
        div.className = "file-card";
        
        const isImage = file.type.startsWith("image/");
        let thumbnail = `<div class="thumbnail"><i class="ri-file-text-line"></i></div>`;
        
        if (isImage) {
            const url = URL.createObjectURL(file);
            thumbnail = `<img src="${url}" class="thumbnail" onload="URL.revokeObjectURL(this.src)">`;
        }

        const sizeStr = (file.size / 1024).toFixed(1) + " KB";
        
        div.innerHTML = `
            ${thumbnail}
            <div class="file-info">
                <span class="file-name">${file.name}</span>
                <div class="meta-stats">
                    <div class="stat-group">
                        <span class="stat-label">Original</span>
                        <span>${sizeStr}</span>
                    </div>
                     <div class="stat-group">
                        <span class="stat-label">Cleaned</span>
                        <span class="size-after">---</span>
                    </div>
                </div>
                <div class="file-status" style="margin-top:5px; font-size:0.85rem; color:#000;">Processing...</div>
            </div>
            <div class="download-area"></div>
        `;
        return div;
      }

      function markError(ui, msg) {
        ui.card.classList.add("error");
        ui.status.innerHTML = `<span class="error-msg"><i class="ri-error-warning-fill"></i> ${msg}</span>`;
        ui.afterSize.innerText = "FAILED";
      }

      function markSuccess(ui, blob, url, originalName) {
        ui.card.classList.add("success");
        ui.card.classList.add("success");
        ui.status.innerHTML = `<span style="color:#008080; font-weight:bold;">Scrubbed</span>`;
        
        const newSize = (blob.size / 1024).toFixed(1) + " KB";
        ui.afterSize.innerText = newSize;

        const btn = document.createElement("a");
        btn.href = url;
        btn.className = "download-btn";
        btn.innerHTML = `<i class="ri-download-2-line"></i> DOWNLOAD`;
        btn.download = `clean_${originalName}`;
        
        ui.downloadArea.innerHTML = "";
        ui.downloadArea.appendChild(btn);
      }
    </script>
  </body>
</html>
